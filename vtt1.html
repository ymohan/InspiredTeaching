<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Podcast Player</title>  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
	<main class="main-wraper">
		<!-- Header -->
		<header class="header">
			<div class="container">
				<div class="row align-items-center justify-content-between">
					  <!-- Left: Logo -->
					  <div class="col-auto">
						<div class="logo">
						  <h2><a href="#">Inspired Teaching</a></h2>
						</div>
					</div>
					<!-- Center: Navigation -->
					<div class="col d-none d-lg-flex justify-content-center">
						<nav class="header-nav" aria-label="Main navigation">
							<a href="index.html" class="nav-item">HOME</a>
						  
						</nav>
					</div>
					<!-- Right: Search + Contact -->
					<div class="col-auto custom-nav d-flex align-items-center gap-2">
						<form id="searchForm" class="search-inline" onsubmit="return false;">
						  <input id="searchInput" type="search"
							placeholder="Search stories or songs"
							aria-label="Search">
						</form>
						<div class="header-btn">
						  <a href="https://www.languageresearchlab.in/contact" target="_blank">Contact Us</a>
						</div>
						<!-- Mobile toggle button -->
						<div class="mobile-toggle">
							<span></span>
							<span></span>
							<span></span>
						</div>
					</div>
				</div>
			</div>
		</header>
		<!--Mobile-Menu-->
		<div class="mobile-menu">
			<div class="mobile-close"></div>
			<ul class="mobile-nav-menu">
				<li class="mobile-nav-item"><a href="#" class="mobile-nav-link">Home</a></li>
				<li class="mobile-nav-item"><a href="#storyGrid" class="mobile-nav-link">Story</a></li>
				<li class="mobile-nav-item"><a href="#songsGrid" class="mobile-nav-link">Songs</a></li>			
			</ul>
		</div>

		<section class="hero pt-5">
			<div class="bebgadd__box">
				<div class="container">
					<h1 class="title" id="page-title">Learn... Play... Grow</h1>
					<div class="player-container">
						<img src="https://images.unsplash.com/photo-1614701863964-0be68f5f4f5b?w=400&h=400&fit=crop" alt="Podcast Cover" class="cover-art cover-thumb" id="cover-art" />
						<div class="waveform">
							<canvas id="waveform-canvas"></canvas>
							<div class="progress-bars">
								<div class="progress-fill" id="progress-fill"></div>
								<div class="progress-handle" id="progress-handle"></div>
							</div>
						</div>
					</div>
					
					<div class="controls">
					  <button class="nav-btn" id="prev-btn" title="Previous"><i class="fa-solid fa-chevron-left"></i></button>
					  <button class="play-btn" id="play-pause-btn"><i class="fa-solid fa-play"></i></button>
					  <button class="nav-btn" id="next-btn" title="Next"><i class="fa-solid fa-chevron-right"></i></button>
					</div>

					<!-- Tabs -->
					<div class="tabs" id="tabs"></div>
					<div class="tab-content">
					  <div id="transcript" class="tab-pane">
						<div id="transcript-lines"></div>
					  </div>
					</div>
				</div>
			</div>
		</section>

		<!-- Audio -->
		<audio id="audio" preload="metadata">
		  <!-- source will be set dynamically if a selection exists -->
		  <source id="audio-source" src="" type="audio/mpeg" />
		</audio>
	
		<footer class="footer__section-1 pl-24 pr-24">
           <div class="container">
              <div class="footer__top">
                 <div class="row g-4">
                    <div class="col-lg-4 col-md-6 col-sm-6 quick__space">
                       <div class="footer__widget">
                          <h4 class="white mb-5">
                             Quick Link
                          </h4>
                          <div class="link__attach d-flex">
                             <ul class="link">
                                <li class="mb-16">
                                   <a href="https://www.languageresearchlab.in/about.html" target="_blank" rel="noopener noreferrer" class="fs-16 fw-400 bodyfont pra">
                                       About
                                    </a>
                                </li>
                                <li class="mb-16">
                                   <a href="#storyGrid" class="fs-16 fw-400 bodyfont pra">
                                     Story Telling
                                   </a>
                                </li>
                                <li>
                                   <a href="#songsGrid" class="fs-16 fw-400 bodyfont pra">
                                      Songs
                                   </a>
                                </li>
                             </ul>
                             <ul class="link">
                                <li class="mb-16">
                                   <a href="https://www.languageresearchlab.in/index.html" target="_blank" rel="noopener noreferrer" class="fs-16 fw-400 bodyfont pra">
                                       Language Research Lab
                                    </a>
                                </li>
                                <li class="mb-16">
                                   <a href="#" class="fs-16 fw-400 bodyfont pra">
                                      Podcasts
                                   </a>
                                </li>
                                <li>
                                   <a href="https://languageresearchlab.in/cala/index.php" target="_blank" rel="noopener noreferrer" class="fs-16 fw-400 bodyfont pra">
                                      Blog
                                    </a>
                                </li>
                             </ul>
                          </div>
                          <div class="footer__form">
                             <h4 class="white mb-24">
                                Newslatter Our
                             </h4>
                             <form action="#0" class="d-flex align-items-center justify-content-between gap-1">
                                <input type="email" placeholder="Email address">
                                <button type="submit"><span>Go</span></button>
                             </form>
                          </div>
                       </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-6 footer__streamio">
                      <div class="footer__widget text-center">
                          <h4 class="white mb-5">
                             Curious minds start here
                          </h4>
                          <a href="index.html" class="d-block mb-3">
                             <img src="images/favicon.png" alt="img" class="mb-3">
                             <p class="white-head">
                                Inspired Teaching
                             </p>
                          </a>
                          <p class="white-head">
                             Play ... Listen ... Grow ...
                          </p>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-6 footercontact__link">
                       <div class="footer__widget">
                          <h4 class="white mb-5">
                             Contact
                          </h4>
                          <div class="link__attach d-flex">
                             <p> Pudunagar,<br> Alankuppam,<br>Auroville, <br> puducherry, Tamilnadu. 605101 </p>
                              <ul class="link">
                                <li class="mb-0">
                                   <a href="javascript:void(0)" class="fs-16 fw-400 bodyfont pra">
                                      IN: +91 7386431032
                                   </a>
                                </li>
                                <li>
                                   <a href="javascript:void(0)" class="fs-16 fw-400 bodyfont pra">
                                      rajaraghu@gmail.com
                                   </a>
                                </li>
                             </ul>
                          </div>
                          <ul class="social d-flex align-items-center">
                             <li>
                                <a href="javascript:void(0)">
                                   <i class="fa-brands fa-facebook"></i>
                                </a>
                             </li>
                             <li>
                                <a href="javascript:void(0)">
                                   <i class="fa-brands fa-google"></i>
                                </a>
                             </li>
                             <li>
                                <a href="javascript:void(0)">
                                   <i class="fa-brands fa-youtube"></i>
                                </a>
                             </li>
                             <li>
                                <a href="javascript:void(0)">
                                   <i class="fa-brands fa-twitter"></i>
                                </a>
                             </li>
                             <li>
                                <a href="javascript:void(0)">
                                   <i class="fa-brands fa-linkedin"></i>
                                </a>
                             </li>
                          </ul>
                       </div>
                    </div>
                 </div>
              </div>
              <div class="footer__bottom d-flex align-items-center">
                 <p class="pra fs-14 fw-400 bodyfont">
                    Copyright Â© Inspired Teaching 
                 </p>
                 <ul class="privacy d-flex align-items-center gap-4">
                    <li>
                       <a href="#" class="fs-14 fw-400 bodyfont white-head">
                          Privacy
                       </a>
                    </li>
                    <li>
                       <a href="#" class="fs-14 fw-400 bodyfont white-head">
                          Terms &amp; Conditions
                       </a>
                    </li>
                 </ul>
              </div>
           </div>
        </footer>

			
		<div class="audio-player">
			<div class="track-info">
			  <img src="mu.png" alt="Track Cover" id="track-artwork">
			  <div class="text">
				<p id="track-title">No track selected</p>
				<p id="track-artist">Select a track to play</p>
			  </div>
			</div>
			<div class="player-controls">
			  <button id="prev-track">
				<i class="fas fa-step-backward"></i>
			  </button>
			  <button id="play-pause">
				<i class="fas fa-play"></i>
			  </button>
			  <button id="next-track">
				<i class="fas fa-step-forward"></i>
			  </button>
			</div>
			<div class="progress-area">
			  <span id="current-time">0:00</span>
			  <div class="progress-bar">
				<div class="progress"></div>
			  </div>
			  <span id="duration">0:00</span>
			</div>
			<div class="volume-controls">
			  <i class="fas fa-volume-up" id="volume-icon"></i>
			  <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
			</div>
			
		</div>
	</main>
			<!-- Scroll to top button -->
    <button id="scrollTopBtn" class="scroll-top-btn" aria-label="Scroll to top" title="Back to top">
      <i class="fas fa-arrow-up"></i>
    </button>
	
	<!--js scripts starts -->
	<script src="js/main.js"></script>		
	<script>
	    // scroll-to-top script (unchanged)
		document.addEventListener('DOMContentLoaded', () => {
		  const btn = document.getElementById('scrollTopBtn');
		  if (!btn) return;
		  const root = document.documentElement;
		  const threshold = 400;
		  const toggleVisibility = () => {
			const scrolled = root.scrollTop;
			btn.classList.toggle('visible', scrolled > threshold);
		  };
		  btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
		  let ticking = false;
		  window.addEventListener('scroll', () => {
			if (!ticking) {
			  requestAnimationFrame(() => { toggleVisibility(); ticking = false; });
			  ticking = true;
			}
		  });
		  toggleVisibility();
		});
	</script>

	<script>
	/* ===== unified player script â€” replaces previous block ===== */
	document.addEventListener('DOMContentLoaded', () => {
	  const safeParse = raw => { try { return JSON.parse(raw); } catch { return null; } };

	  /* DOM references (main audio is the single source-of-truth) */
	  const audio = document.getElementById('audio');
	  const mainPlayBtn = document.getElementById('play-pause-btn');
	  const progFill = document.getElementById('progress-fill');
	  const progHandle = document.getElementById('progress-handle');
	  const progBarWrap = document.querySelector('.progress-bars');
	  const canvas = document.getElementById('waveform-canvas');
	  const ctx = canvas.getContext('2d');
	  const transcriptDiv = document.getElementById('transcript-lines');
	  const cover = document.getElementById('cover-art');
	  const titleEl = document.getElementById('page-title');
	  const prevBtn = document.getElementById('prev-btn');
	  const nextBtn = document.getElementById('next-btn');

	  /* sticky (bottom) UI */
	  const sticky = document.querySelector('.audio-player') || null;
	  const stickyPlayBtn = document.getElementById('play-pause');
	  const stickyPrev = document.getElementById('prev-track');
	  const stickyNext = document.getElementById('next-track');
	  const stickyTitle = document.getElementById('track-title');
	  const stickyArtist = document.getElementById('track-artist');
	  const stickyArt = document.getElementById('track-artwork');
	  const stickyProgress = document.querySelector('.audio-player .progress');
	  const stickyCurrent = document.getElementById('current-time');
	  const stickyDuration = document.getElementById('duration');
	  const stickyVolume = document.getElementById('volume');

	  /* transcript cues */
	  let cues = [];

	  /* ---------- load selected track (shared) ---------- */
	  const loadTrack = () => {
		const raw = localStorage.getItem('selectedTrack');
		if (!raw) {
		  transcriptDiv.innerHTML = '<p class="text-muted">No episode selected</p>';
		  stickyTitle && (stickyTitle.textContent = 'No track selected');
		  stickyArtist && (stickyArtist.textContent = 'Select a track to play');
		  stickyArt && (stickyArt.src = 'mu.png');
		  return;
		}
		const sel = safeParse(raw);
		if (!sel?.track) return;

		// set audio source (single audio element)
		audio.src = sel.track;
		audio.load();

		// update both UIs
		if (sel.poster && cover) cover.src = sel.poster;
		if (sel.poster && stickyArt) stickyArt.src = sel.poster;
		if (sel.title) {
		  titleEl && (titleEl.textContent = sel.title);
		  stickyTitle && (stickyTitle.textContent = sel.title);
		  document.title = `${sel.title} â€” Podcast`;
		}
		if (sel.singer || sel.artist) stickyArtist && (stickyArtist.textContent = sel.singer || sel.artist);

		// transcript + waveform placeholder
		loadTranscript(sel.transcript || null);
		drawWaveformPlaceholder();
	  };

	  /* ---------- transcript parsing ---------- */
	  const loadTranscript = url => {
		transcriptDiv.innerHTML = '<p class="text-muted">Loading transcript...</p>';
		if (!url) { transcriptDiv.innerHTML = '<p class="text-muted">No transcript</p>'; return; }
		const abs = new URL(url, location.href).href;
		fetch(abs)
		  .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
		  .then(parseVtt)
		  .catch(() => { transcriptDiv.innerHTML = '<p class="text-muted">Transcript unavailable</p>'; });
	  };
	  const parseVtt = txt => {
		txt = txt.replace(/\uFEFF/g,'').replace(/\r\n/g,'\n').trim().replace(/^WEBVTT.*\n?/i,'').trim();
		const blocks = txt.split(/\n{2,}/).map(b=>b.trim()).filter(Boolean);
		transcriptDiv.innerHTML = ''; cues = [];
		blocks.forEach(b => {
		  const lines = b.split('\n').map(l=>l.trim()).filter(Boolean);
		  const ti = lines.findIndex(l=>l.includes('-->'));
		  if (ti===-1) return;
		  const [s,e] = lines[ti].split('-->').map(p=>p.trim().split(/\s+/)[0].replace(',','.'));
		  const start = parseTime(s), end = parseTime(e);
		  if (isNaN(start)||isNaN(end)||end<=start) return;
		  const content = lines.slice(ti+1).join(' ').trim();
		  if (!content) return;
		  const el = document.createElement('div');
		  el.className='cue'; el.textContent=content;
		  el.dataset.start=start; el.dataset.end=end;
		  transcriptDiv.appendChild(el);
		  cues.push(el);
		});
		if (!cues.length) transcriptDiv.innerHTML = '<p class="text-muted">No transcript</p>';
	  };
	  const parseTime = t => {
		const p = t.split(':').map(v=>parseFloat(v));
		if (p.length===3) return p[0]*3600+p[1]*60+p[2];
		if (p.length===2) return p[0]*60+p[1];
		return p[0]||0;
	  };

	  /* ---------- Play / Pause (centralized) ---------- */
	  const setPlayIcons = isPlaying => {
		// main button
		if (mainPlayBtn) {
		  const i = mainPlayBtn.querySelector('i');
		  if (i) i.className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
		}
		// sticky button
		if (stickyPlayBtn) {
		  const i2 = stickyPlayBtn.querySelector('i');
		  if (i2) i2.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
		}
		
		
	  if (stickyArt) stickyArt.classList.toggle('rotating', isPlaying);
	  };

	  // main play button toggles audio
	  mainPlayBtn && mainPlayBtn.addEventListener('click', () => {
		audio.paused ? audio.play().catch(()=>{}) : audio.pause();
	  });

	  // sticky play toggles audio (controls same audio element)
	  stickyPlayBtn && stickyPlayBtn.addEventListener('click', () => {
		audio.paused ? audio.play().catch(()=>{}) : audio.pause();
	  });

	  // audio events update both UIs
	  audio.addEventListener('play', () => setPlayIcons(true));
	  audio.addEventListener('pause', () => setPlayIcons(false));
	  audio.addEventListener('ended', () => setPlayIcons(false));

	  /* ---------- Progress + seeking (main progress bar + sticky) ---------- */
	  function formatTime(sec=0) {
		sec = Math.max(0, Math.floor(sec));
		const m = Math.floor(sec/60);
		const s = sec % 60;
		return `${m}:${s.toString().padStart(2,'0')}`;
	  }

	  audio.addEventListener('timeupdate', () => {
		if (!audio.duration || isNaN(audio.duration)) return;
		const pct = (audio.currentTime / audio.duration) * 100;
		progFill.style.width = `${pct}%`;
		progHandle.style.left = `${pct}%`;
		drawWaveformProgress(pct);

		// sticky progress update
		if (stickyProgress) stickyProgress.style.width = `${pct}%`;
		if (stickyCurrent) stickyCurrent.textContent = formatTime(audio.currentTime);
		if (stickyDuration && audio.duration && !isNaN(audio.duration)) stickyDuration.textContent = formatTime(audio.duration);

		// highlight cues
		const t = audio.currentTime;
		cues.forEach(c=>c.classList.toggle('active', t>=+c.dataset.start && t<+c.dataset.end));
	  });

	  // seeking on the main waveform progress
	  let dragging = false;
	  progBarWrap && progBarWrap.addEventListener('mousedown', e=>{ dragging=true; seekFromEvent(e); });
	  document.addEventListener('mousemove', e=>{ if(dragging) seekFromEvent(e); });
	  document.addEventListener('mouseup', ()=>{ dragging=false; });
	  const seekFromEvent = e => {
		if (!progBarWrap || !audio.duration) return;
		const r = progBarWrap.getBoundingClientRect();
		const pct = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
		audio.currentTime = pct * audio.duration;
	  };

	  // seeking on sticky progress click (if user clicks the sticky progress bar wrapper)
	  const stickyProgressBarWrap = document.querySelector('.audio-player .progress-bar');
	  stickyProgressBarWrap && stickyProgressBarWrap.addEventListener('click', e => {
		if (!audio.duration) return;
		const r = stickyProgressBarWrap.getBoundingClientRect();
		const pct = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
		audio.currentTime = pct * audio.duration;
	  });

	  /* ---------- Prev / Next (re-use existing functions) ---------- */
	  const discover = () => {
		const keys = ['playlist','tracks','episodes','episodeList','allTracks'];
		for (const k of keys) {
		  const raw = localStorage.getItem(k);
		  if (!raw) continue;
		  const p = safeParse(raw);
		  if (Array.isArray(p) && p.length) return p;
		  if (p?.items && Array.isArray(p.items)) return p.items;
		}
		const sel = safeParse(localStorage.getItem('selectedTrack')||'{}');
		return sel?.list || sel?.playlist || sel?.trackList || null;
	  };
		/* vtt1.html - Replace the existing setSel function with this */
		/* REPLACE your existing setSel function in vtt1.html with this one */
		/* vtt1.html - Inside the <script> tag */

     /* REPLACE your existing setSel function in vtt1.html with this one */
      const setSel = obj => {
        if (!obj?.track) return;

        // 1. FIND THE ID (Auto-detect based on playlist position)
        // If the object doesn't have an ID, we calculate it from the playlist
        let trackId = obj.id;
        if (!trackId) {
            const pl = discover() || [];
            const idx = pl.findIndex(t => t.track === obj.track);
            if (idx !== -1) {
                trackId = (idx + 1).toString(); // Convert 0 -> "1", 1 -> "2"
            } else {
                trackId = "1"; // Fallback
            }
            obj.id = trackId; // Save it to the object
        }

        // 2. Save to localStorage
        localStorage.setItem('selectedTrack', JSON.stringify(obj));
        localStorage.setItem('selectedTrack_ts', String(Date.now()));

        // 3. Update Sticky UI
        if (stickyTitle) stickyTitle.textContent = obj.title || 'Untitled';
        if (stickyArtist) stickyArtist.textContent = obj.singer || obj.artist || '';
        if (stickyArt && obj.poster) stickyArt.src = obj.poster;

        // 4. Update Page UI
        if (titleEl) { titleEl.textContent = obj.title || 'Untitled'; document.title = `${obj.title} â€” Podcast`; }
        if (cover && obj.poster) cover.src = obj.poster;

        // 5. Play Audio
        audio.src = obj.track;
        audio.load();
        audio.play().catch(()=>{});
        loadTranscript(obj.transcript || null);
        drawWaveformPlaceholder();

        // 6. TRIGGER MAIN.JS (The Critical Fix)
        // Explicitly tell main.js to load the JSON for this ID
        if (typeof window.loadTrack === 'function') {
            console.log("Auto-Detected ID:", trackId, "- Calling main.js...");
            window.loadTrack(trackId);
        }
      };

	  // helpers to identify current index
	  const curIdx = pl => {
		const src = audio.src || '';
		let i = pl.findIndex(t=>t.track===src || t.track===decodeURIComponent(src));
		if (i===-1) {
		  const name = src.split('/').pop();
		  i = pl.findIndex(t=>(t.track||'').split('/').pop()===name);
		}
		return i;
	  };

	  prevBtn && prevBtn.addEventListener('click', () => {
		const pl = discover(); if (!pl?.length) return;
		const i = curIdx(pl);
		const ni = (i===-1?0:(i-1+pl.length)%pl.length);
		setSel(pl[ni]);
	  });
	  nextBtn && nextBtn.addEventListener('click', () => {
		const pl = discover(); if (!pl?.length) return;
		const i = curIdx(pl);
		const ni = (i===-1?0:(i+1)%pl.length);
		setSel(pl[ni]);
	  });

	  // wire sticky prev/next to reuse the same logic
	  stickyPrev && stickyPrev.addEventListener('click', () => prevBtn && prevBtn.click());
	  stickyNext && stickyNext.addEventListener('click', () => nextBtn && nextBtn.click());

	  /* ---------- Volume control (sticky slider drives main audio) ---------- */
	  if (stickyVolume) {
		stickyVolume.addEventListener('input', e => {
		  audio.volume = parseFloat(e.target.value);
		});
		// initialize slider from audio volume
		stickyVolume.value = audio.volume != null ? audio.volume : 1;
	  }

	  /* ---------- Waveform analyser (kept from original) ---------- */
	  let analyser, dataArray, barCount, barWidth, gapPx;
	  let rafId = null, lastPct = -1;
	  const initAnalyser = () => {
		if (analyser) return;
		const AudioCtx = window.AudioContext || window.webkitAudioContext;
		try {
		  const Ctx = new AudioCtx();
		  analyser = Ctx.createAnalyser();
		  analyser.fftSize = 2048;
		  analyser.smoothingTimeConstant = 0.8;
		  const source = Ctx.createMediaElementSource(audio);
		  source.connect(analyser);
		  analyser.connect(Ctx.destination);
		  dataArray = new Uint8Array(analyser.frequencyBinCount);
		} catch (err) {
		  // AudioContext may be blocked until user gesture â€” ignore gracefully
		  analyser = null;
		}
	  };

	 const resizeWaveform = () => {
		// Check if the canvas element is available before proceeding
		if (!canvas || !ctx) return;
		
		const rect = canvas.parentElement.getBoundingClientRect();
		const dpr = window.devicePixelRatio || 1;
		
		// ðŸ’¡ Mobile Check: Determine the target height
		let targetHeight = rect.height; // Default to parent's height
		const isMobileView = window.innerWidth < 768; // Use 768px as the mobile breakpoint

		if (isMobileView) {
			targetHeight = 80; // Set height to 80px for mobile view
		}
		
		// Set canvas dimensions (actual pixels for rendering)
		canvas.width  = Math.round(rect.width * dpr);
		canvas.height = Math.round(targetHeight * dpr);

		// Set canvas style dimensions (for display size)
		canvas.style.width  = rect.width + 'px';
		canvas.style.height = targetHeight + 'px'; // Use the calculated targetHeight

		// Scale context for retina/HiDPI displays
		ctx.setTransform(1,0,0,1,0,0);
		ctx.scale(dpr, dpr);
		
		// Waveform calculation (unchanged)
		const w = rect.width;
		gapPx = 1;
		barCount = Math.max(1, Math.floor(w / (2 + gapPx)));
		barWidth = (w - gapPx * (barCount - 1)) / barCount;
		drawFullWaveform();
		lastPct = -1;
	};

	  const drawWaveformPlaceholder = () => {
		// small placeholder until analyser runs
		const h = canvas.parentElement.clientHeight;
		ctx.clearRect(0,0,canvas.width,canvas.height);
		ctx.fillStyle = '#2b2b2b';
		const w = canvas.parentElement.clientWidth;
		const cols = Math.max(1, Math.floor(w / 10));
		const bw = (w - (cols-1)*gapPx)/cols;
		let x=0;
		for (let i=0;i<cols;i++){
		  const barH = (0.25 + ((i%3)/6)) * h;
		  const y=(h-barH)/2;
		  ctx.fillRect(x,y,bw,barH);
		  x+=bw+gapPx;
		}
	  };

	  const drawFullWaveform = () => {
		if (!analyser) { drawWaveformPlaceholder(); return; }
		analyser.getByteTimeDomainData(dataArray);
		const h = canvas.parentElement.clientHeight;
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		const step = Math.max(1, Math.floor(dataArray.length / barCount));
		let x = 0;
		for (let i = 0; i < barCount; i++) {
		  let sum = 0;
		  const start = i * step;
		  const end   = Math.min(start + step, dataArray.length);
		  for (let j = start; j < end; j++) {
			const v = dataArray[j] / 128.0;
			sum += Math.abs(v - 1);
		  }
		  const avg   = sum / (end - start);
		  const barH  = Math.min(avg * h * 1.8, h * 0.9);
		  const y     = (h - barH) / 2;
		  ctx.fillStyle = '#fff';
		  ctx.fillRect(x, y, barWidth, barH);
		  x += barWidth + gapPx;
		}
	  };

	  const drawWaveformProgress = pct => {
		if (pct === lastPct) return;
		lastPct = pct;
		const w = canvas.parentElement.clientWidth;
		const clipW = (pct / 100) * w;
		if (clipW <= 0) { ctx.clearRect(0,0,canvas.width,canvas.height); drawFullWaveform(); return; }
		const off = document.createElement('canvas');
		off.width = canvas.width; off.height = canvas.height;
		const offCtx = off.getContext('2d');
		offCtx.drawImage(canvas, 0, 0);
		ctx.clearRect(0,0,canvas.width,canvas.height);
		ctx.save();
		ctx.fillStyle = '#1db954';
		ctx.fillRect(0, 0, clipW, canvas.parentElement.clientHeight);
		ctx.globalCompositeOperation = 'source-in';
		ctx.drawImage(off, 0, 0);
		ctx.restore();
	  };

	  const startRaf = () => {
		if (rafId) return;
		const loop = () => {
		  drawFullWaveform();
		  rafId = requestAnimationFrame(loop);
		};
		rafId = requestAnimationFrame(loop);
	  };
	  const stopRaf = () => { if (rafId) cancelAnimationFrame(rafId); rafId=null; };

	  audio.addEventListener('loadedmetadata', () => {
		initAnalyser();
		resizeWaveform();
		if (!audio.paused) startRaf();
	  });
	  audio.addEventListener('play', startRaf);
	  audio.addEventListener('pause', stopRaf);
	  audio.addEventListener('ended', stopRaf);
	  window.addEventListener('resize', resizeWaveform);

	  resizeWaveform();

	  /* ---------- Prev/Next discovery wiring for sticky already covered by setSel above ---------- */

	  /* ---------- Sync across tabs/pages ---------- */
	  window.addEventListener('storage', ev => {
		if (!ev.key) return;
		if (['selectedTrack','selectedTrack_ts','playlist'].includes(ev.key)) loadTrack();
	  });
	  window.addEventListener('selectedTrackUpdated', loadTrack);

	  /* ---------- Initial load ---------- */
	  loadTrack();

	  /* ---------- Safety: if there is a second audio element in sticky, remove it to avoid conflicts ---------- */
	  try {
		const extra = document.querySelector('.audio-player audio');
		if (extra && extra !== audio) extra.remove();
	  } catch (e) {}

	  /* ---------- Initialize sticky UI time/duration text if available ---------- */
	  if (stickyDuration && audio.duration && !isNaN(audio.duration)) stickyDuration.textContent = formatTime(audio.duration);
	  if (stickyCurrent) stickyCurrent.textContent = formatTime(0);

	}); /* DOMContentLoaded */
	</script>

</body>
</html>

